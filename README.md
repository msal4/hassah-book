# Hassah Book API
The backend for Hassah Book.
### Requirements
- [Node](https://nodejs.org)
- [Yarn](https://yarnpkg.com/)
- [Postgres](https://www.postgresql.org/)
- [Docker](https://www.docker.com/) (optional)

### Setup
- Create a .env file
  ```bash
  cp .env.example .env
  ```
  set all the required variables.


### Run
- Using docker
  ```bash
  docker build -t <app-tag> .
  docker run -it <app-tag>
  ```
- Without docker
  ```bash
  yarn
  yarn start
  ```
### Deploy
- Docker Compose
    - create a `docker-compose.yml` file and add your dependencies there (e.g. postgres)
    - upload to the server (e.g. using git)
    - build and run using `docker-compose`
- Dokku
    - install the postgres plugin
    - create a postgres service
      ```bash
      dokku postgres:create <SERVICE_NAME> -I 12.5
      ```
      NOTE: postgres version must be 12.5 or higher.
    - link postgres
      ```bash
      dokku postgres:link <APP_NAME> <POSTGRES_SERVICE_NAME> -a TYPEORM_URL
      ```
    - using `dokku config` set your environment variables
      ```bash
      dokku config:set <APP_NAME> TYPEORM_CONNECTION=postgres JWT_SECRET=mysecret ...
      ```
    - push to dokku, for more details checkout the [dokku docs](http://dokku.viewdocs.io/dokku/)
    - run the migrations
      ```bash
      dokku run <APP_NAME> yarn orm migration:run
      ```
    - Linking to a domain (optional):
        - change the app port to 80
          ```bash
            dokku proxy:ports-add <APP_NAME> http:80:<PORT> # the port in .env
          ```
        - add the domain
          ```bash
          dokku domains:set <APP_NAME> <DOMAIN>
          ```
          NOTE: make sure to remove the default domain/subdomain generated by dokku using
          ```bash
          dokku domains:remove <APP_NAME> <DOMAIN>
          ```
        - https
          ```bash
          dokku config:set --no-restart <APP_NAME> DOKKU_LETSENCRYPT_EMAIL=<EMAIL_ADDRESS>
          dokku letsencrypt <APP_NAME> 
          ``` 
